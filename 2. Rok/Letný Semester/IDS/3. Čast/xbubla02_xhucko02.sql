DROP TABLE student CASCADE CONSTRAINT;
DROP TABLE predmet CASCADE CONSTRAINT;
DROP TABLE skuska CASCADE CONSTRAINT;
DROP TABLE hodnotenie CASCADE CONSTRAINT;
DROP TABLE ucitel CASCADE CONSTRAINT;
DROP TABLE osoba CASCADE CONSTRAINT;
DROP TABLE termin CASCADE CONSTRAINT;
DROP TABLE zapisuje_sa CASCADE CONSTRAINT;
DROP TABLE prihlasuje_sa CASCADE CONSTRAINT;
DROP TABLE otazka CASCADE CONSTRAINT;
DROP TABLE vyucuje CASCADE CONSTRAINT;


CREATE TABLE skuska(
    ID_skuska NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_predmet VARCHAR(20) NOT NULL UNIQUE, --Foreign Key
    login_u VARCHAR(20) NOT NULL, --Foreign
    otvorenie_prihlasovania TIMESTAMP,
    zatvorenie_prihlasovania TIMESTAMP,
    max_pocet_studentov INTEGER NOT NULL,
    max_pocet_bodov INTEGER NOT NULL,
    min_pocet_bodov INTEGER NOT NULL,
    pocet_otazok INTEGER NOT NULL,
    zverejnenie NUMBER(1,0) NOT NULL,
    pocet_terminov INTEGER NOT NULL,
    typ_skusky VARCHAR(10) NOT NULL, --pol = polsemestralka, sem = semestralka
    
    CHECK (otvorenie_prihlasovania < zatvorenie_prihlasovania),
    CHECK (max_pocet_studentov >= 0),
    CHECK (max_pocet_bodov >= 0),
    CHECK (min_pocet_bodov >= 0),
    CHECK (pocet_otazok >= 0),
    CHECK ((typ_skusky = 'sem' AND pocet_terminov >= 3) OR (typ_skusky = 'pol' AND pocet_terminov >= 1))
);


CREATE TABLE osoba(
    login VARCHAR(20) PRIMARY KEY,
    meno VARCHAR(30) NOT NULL,
    heslo VARCHAR(30) NOT NULL,
    email VARCHAR(50) NOT NULL
);


CREATE TABLE student(
    login_s VARCHAR(20) PRIMARY KEY,
    rocnik INTEGER NOT NULL,
    
    CHECK (rocnik >= 1)
);



CREATE TABLE predmet(
    ID_predmet VARCHAR(20) PRIMARY KEY,
    login_u VARCHAR(20), --Foreign, garant
    zapocet NUMBER NOT NULL,

    CHECK (zapocet >= 0)
);


CREATE TABLE ucitel(
    login_u VARCHAR(20) PRIMARY KEY
);


CREATE TABLE hodnotenie(
    ID_hodnotenie NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_termin NUMBER NOT NULL, --Foreign
    login_u VARCHAR(20) NOT NULL, --Foreign
    login_s VARCHAR(20)NOT NULL, --Foreign
    datum_hodnotenia TIMESTAMP NOT NULL,
    pocet_bodov NUMBER NOT NULL,
    bodovanie_otazok VARCHAR(50), --Pocty bodov za jednotlive otazky v tvare (5|10|12|1 ....)
    
    CHECK (pocet_bodov >= 0)
);


CREATE TABLE termin(
    ID_termin NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_skuska NUMBER NOT NULL, --Foreign
    cas_konania TIMESTAMP NOT NULL
);


CREATE TABLE prihlasuje_sa(
    ID_termin NUMBER NOT NULL, --Foreign
    login_s VARCHAR(20) NOT NULL  --Foreign
);


CREATE TABLE zapisuje_sa(
    ID_predmet VARCHAR(20) NOT NULL, --Foreign
    login_s VARCHAR(20) NOT NULL,      --Foreign
    pocet_ziskanych_bodov NUMBER NOT NULL,
    
    CHECK (pocet_ziskanych_bodov >= 0)
);


CREATE TABLE otazka(
    ID_otazka NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_skuska NUMBER NOT NULL, --Foreign
    zadanie VARCHAR(200)
);


CREATE TABLE vyucuje(
    ID_predmet VARCHAR(20) NOT NULL, --Foreign
    login_u VARCHAR(20) NOT NULL -- Foreign
); 


--Composite Keys:
ALTER TABLE vyucuje ADD CONSTRAINT pk_vyucuje PRIMARY KEY (ID_predmet, login_u);
ALTER TABLE zapisuje_sa ADD CONSTRAINT pk_zapisuje_sa PRIMARY KEY (ID_predmet, login_s);
ALTER TABLE prihlasuje_sa ADD CONSTRAINT pk_prihlasuje_sa PRIMARY KEY (ID_termin, login_s);


--Foreign Keys:
ALTER TABLE skuska ADD CONSTRAINT fk_ID_predmet FOREIGN KEY (ID_predmet) REFERENCES predmet(ID_predmet);
ALTER TABLE skuska ADD CONSTRAINT fk_login FOREIGN KEY (login_u) REFERENCES ucitel(login_u);

ALTER TABLE predmet ADD CONSTRAINT fk_login4 FOREIGN KEY (login_u) REFERENCES ucitel(login_u);
ALTER TABLE hodnotenie ADD CONSTRAINT fk_login5 FOREIGN KEY (login_u) REFERENCES ucitel(login_u);
ALTER TABLE hodnotenie ADD CONSTRAINT fk_login9 FOREIGN KEY (login_s, ID_termin) REFERENCES prihlasuje_sa(login_s, ID_termin);

ALTER TABLE termin ADD CONSTRAINT fk_ID_skuska FOREIGN KEY (ID_skuska) REFERENCES skuska(ID_skuska);

ALTER TABLE prihlasuje_sa ADD CONSTRAINT fk_ID_termin2 FOREIGN KEY (ID_termin) REFERENCES termin(ID_termin);
ALTER TABLE prihlasuje_sa ADD CONSTRAINT fk_login6 FOREIGN KEY (login_s) REFERENCES student(login_s);

ALTER TABLE zapisuje_sa ADD CONSTRAINT fk_ID_predmet2 FOREIGN KEY (ID_predmet) REFERENCES predmet(ID_predmet);
ALTER TABLE zapisuje_sa ADD CONSTRAINT fk_login7 FOREIGN KEY (login_s) REFERENCES student(login_s);

ALTER TABLE otazka ADD CONSTRAINT fk_ID_skuska2 FOREIGN KEY (ID_skuska) REFERENCES skuska(ID_skuska) ON DELETE CASCADE;

ALTER TABLE vyucuje ADD CONSTRAINT fk_ID_predmet3 FOREIGN KEY (ID_predmet) REFERENCES predmet(ID_predmet);
ALTER TABLE vyucuje ADD CONSTRAINT fk_login8 FOREIGN KEY (login_u) REFERENCES ucitel(login_u);


--Insert test data:
INSERT INTO osoba VALUES('xhomol00', 'Mato Homola', 'kappa', 'diman230940@debb.me');
INSERT INTO osoba VALUES('xdisco00', 'Jozo Discord', 'lul', 'igor1006@enhytut.com');
INSERT INTO osoba VALUES('xsmith00', 'Ronald Smith', '123456', 'rsmith@debb.com');
INSERT INTO osoba VALUES('xmoody00', 'Augustus Moody', 'OMEGALUL', 'erik3791@sgisfg.com');
INSERT INTO osoba VALUES('xpotte00', 'Harry Potter', 'PeepoHappy', 'irenka933@debb.com');
INSERT INTO osoba VALUES('xlacol00', 'Laco Peter', '123', 'Laco@debb.com');
INSERT INTO osoba VALUES('xpalko00', 'Palo Sekera', '132456', 'Palo@debb.com');

INSERT INTO student VALUES('xhomol00', '1');
INSERT INTO student VALUES('xdisco00', '4');
INSERT INTO student VALUES('xlacol00', '2');
INSERT INTO student VALUES('xpalko00', '3');

INSERT INTO ucitel VALUES('xmoody00');
INSERT INTO ucitel VALUES('xpotte00');
INSERT INTO ucitel VALUES('xsmith00');

INSERT INTO predmet VALUES('IFJ', 'xmoody00', '20');
INSERT INTO predmet VALUES('IUS', 'xpotte00', '30');
INSERT INTO predmet VALUES('IOS', 'xpotte00', '25');
INSERT INTO predmet VALUES('IPK', 'xmoody00', '25');

INSERT INTO zapisuje_sa VALUES('IFJ', 'xhomol00', '0');
INSERT INTO zapisuje_sa VALUES('IFJ', 'xlacol00', '35');
INSERT INTO zapisuje_sa VALUES('IFJ', 'xpalko00', '15');
INSERT INTO zapisuje_sa VALUES('IFJ', 'xdisco00', '0');
INSERT INTO zapisuje_sa VALUES('IUS', 'xdisco00', '50');

INSERT INTO vyucuje VALUES('IFJ', 'xmoody00');
INSERT INTO vyucuje VALUES('IUS', 'xpotte00');

INSERT INTO skuska VALUES('1', 'IFJ', 'xmoody00', '23-03-29 08:00:00', '23-03-31 15:00:00', '300', '50', '0', '2', '1', '3', 'sem');
INSERT INTO skuska VALUES('2', 'IUS', 'xpotte00', '23-04-29 08:00:00', '23-04-30 15:00:00', '200', '20', '0', '1', '1', '1', 'pol');

INSERT INTO termin VALUES('1', '1', '23-04-12 15:00:00');
INSERT INTO termin VALUES('2', '1', '23-04-15 15:00:00');
INSERT INTO termin VALUES('3', '2', '23-04-18 15:00:00');

INSERT INTO prihlasuje_sa VALUES('1', 'xhomol00');
INSERT INTO prihlasuje_sa VALUES('1', 'xlacol00');
INSERT INTO prihlasuje_sa VALUES('1', 'xpalko00');
INSERT INTO prihlasuje_sa VALUES('2', 'xpalko00');
INSERT INTO prihlasuje_sa VALUES('3', 'xdisco00');

INSERT INTO otazka VALUES('1', '1', 'Nakresli na papier obdlznik.');
INSERT INTO otazka VALUES('2', '1', 'Spocitaj na prstoch 5 + 5.');
INSERT INTO otazka VALUES('3', '2', 'Nakresli ER diagram');

INSERT INTO hodnotenie VALUES('1', '1', 'xmoody00', 'xhomol00', '23-04-15 15:00:00', '50', '26|24');
INSERT INTO hodnotenie VALUES('2', '1', 'xmoody00', 'xlacol00', '23-04-15 15:10:00', '30', '12|18');
INSERT INTO hodnotenie VALUES('3', '1', 'xmoody00', 'xpalko00', '23-04-15 15:20:00', '15', '7|8');
INSERT INTO hodnotenie VALUES('4', '2', 'xmoody00', 'xpalko00', '23-04-19 15:20:00', '48', '25|23');
INSERT INTO hodnotenie VALUES('5', '3', 'xpotte00', 'xdisco00', '23-04-20 15:00:00', '20', NULL);

--SELECT:

--Spojenie cez 2 tabulky, zobrazi vsetkych ucitelov ktorý su garanti a akého predmetu
SELECT login_u, ID_predmet FROM ucitel NATURAL JOIN predmet ORDER BY login_u;


--Spojenie cez 2 tabulky, zobrazi studentov a nimi ziskane body z predmetov
SELECT login_s, ID_predmet, pocet_ziskanych_bodov FROM student NATURAL JOIN zapisuje_sa ORDER BY login_s;


--Spojenie cez 3 tabulky, zobrazi hodnotenie terminov pre jednolivych studentov      
SELECT login_s, ID_termin, cas_konania, pocet_bodov, bodovanie_otazok 
    FROM prihlasuje_sa NATURAL JOIN termin NATURAL JOIN hodnotenie ORDER BY login_s;
        
        
--Group By - Zobrazi pocet studentov zapisanych na jednotlive predmety
SELECT ID_predmet, COUNT(*) pocet_studentov FROM zapisuje_sa GROUP BY (ID_predmet);


--Group by - Zobrazi priemer bodov skúšok z predmetov
SELECT skuska.ID_predmet, ROUND(AVG(pocet_bodov)) priemer_bodov 
    FROM skuska NATURAL JOIN termin NATURAL JOIN hodnotenie 
    GROUP BY skuska.ID_predmet
    ORDER BY priemer_bodov DESC;
    
    
--EXIST - Zobrazi predmety na ktoré sa nikto neprihlásil
SELECT ID_predmet FROM predmet 
    WHERE NOT EXISTS (SELECT * FROM zapisuje_sa WHERE predmet.ID_predmet = zapisuje_sa.ID_predmet);


--IN - Zobrazi studentov, ktorý splnili zápoèet a z ktorého predmetu
SELECT login_s, ID_predmet FROM zapisuje_sa WHERE (login_s, ID_predmet)
    IN (SELECT login_s, ID_predmet FROM zapisuje_sa NATURAL JOIN predmet 
            WHERE pocet_ziskanych_bodov >= zapocet) ORDER BY login_s;
